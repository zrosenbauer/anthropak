---
phase: 02-cli-tool-dependencies
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/types.ts
  - packages/cli/src/templates/dependencies-yaml.ts
  - packages/cli/src/lib/config-loader.ts
  - packages/cli/src/commands/init.ts
  - packages/cli/src/commands/update.ts
  - packages/cli/src/cli.ts
autonomous: true

must_haves:
  truths:
    - "Running `anthropak init --yes` completes without any prompts, writes all files with defaults"
    - "Running `anthropak update --yes` completes without any prompts, updates hook script"
    - "Scaffolded dependencies.yaml includes cli_tools section with commented-out examples"
    - "Config validation rejects malformed cli_tools entries (missing name or install)"
    - "--yes mode produces quieter output (less decoration, cleaner for logs)"
  artifacts:
    - path: "packages/cli/src/templates/dependencies-yaml.ts"
      provides: "Updated template with cli_tools section and commented examples"
    - path: "packages/cli/src/commands/init.ts"
      provides: "Init command with --yes flag support"
    - path: "packages/cli/src/commands/update.ts"
      provides: "Update command with --yes flag support"
    - path: "packages/cli/src/lib/config-loader.ts"
      provides: "CLI-side config validation for cli_tools entries"
  key_links:
    - from: "packages/cli/src/commands/init.ts"
      to: "packages/cli/src/types.ts"
      via: "InitOptions.yes property"
      pattern: "yes.*boolean"
    - from: "packages/cli/src/commands/update.ts"
      to: "packages/cli/src/types.ts"
      via: "UpdateOptions.yes property"
      pattern: "yes.*boolean"
    - from: "packages/cli/src/cli.ts"
      to: "packages/cli/src/commands/init.ts"
      via: "yargs command registration"
      pattern: "command\\(init\\)"
---

<objective>
Add --yes flag for non-interactive mode to CLI commands and update the scaffolded template to include cli_tools section with commented-out examples.

Purpose: Enables CI/agent workflows to run `anthropak init --yes` and `anthropak update --yes` without interactive prompts. Updates the scaffolded config to show users how to declare CLI tool dependencies.

Output: CLI commands that support fully non-interactive mode, and a dependencies.yaml template that includes the cli_tools section with example entries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/02-cli-tool-dependencies/02-CONTEXT.md
@.planning/phases/02-cli-tool-dependencies/02-RESEARCH.md
@.planning/phases/01-core-rebuild/01-02-SUMMARY.md

@packages/cli/src/types.ts
@packages/cli/src/cli.ts
@packages/cli/src/commands/init.ts
@packages/cli/src/commands/update.ts
@packages/cli/src/templates/dependencies-yaml.ts
@packages/cli/src/lib/config-loader.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, template update, and config validation</name>
  <files>
    packages/cli/src/types.ts
    packages/cli/src/templates/dependencies-yaml.ts
    packages/cli/src/lib/config-loader.ts
  </files>
  <action>
**packages/cli/src/types.ts — Add CLI tool type and update options:**

Add a `CliToolDependency` interface (synced with hook package):

- `name: string`
- `install: string`

Update `InitOptions` to add `yes: boolean` field.
Update `UpdateOptions` to add `yes: boolean` field.

**packages/cli/src/templates/dependencies-yaml.ts — Uncomment cli_tools section:**

Update the template to include an active `cli_tools` section (NOT the generic `cli` key — per CONTEXT.md the schema uses `cli_tools` with required/optional arrays, but check the existing DependenciesConfig type which uses `cli` as the key).

IMPORTANT: Looking at the existing types, `DependenciesConfig` uses `cli` as the field name. The CONTEXT.md schema example shows `cli_tools:` as the YAML key. Verify which is correct by checking the hook types. The hook types.ts has `cli?: EcosystemSection`. The CONTEXT.md decisions show:

```yaml
cli_tools:
  required:
    - name: docker
      install: "brew install docker"
```

There's a discrepancy: the existing types use `cli` but the user decision says `cli_tools`. The user decision is LOCKED — honor it. This means the YAML key should be `cli_tools` and the TypeScript type field should be updated to `cli_tools` (both in hook and CLI types).

WAIT — this plan only touches CLI files. The hook types are in Plan 01. The CLI types.ts duplicates the hook types. For this plan:

- Update `DependenciesConfig` in CLI's types.ts: rename `cli` to `cli_tools` (the field name)
- Update the template to use `cli_tools:` as the YAML key

The hook's Plan 01 task will need to make the same rename. Add a note about this in the action.

**NOTE TO EXECUTOR:** If Plan 01 runs first and renames `cli` to `cli_tools` in the hook types, great. If this plan runs first, it renames only in CLI types. Either way, both plans independently update their own package's types. The field name `cli_tools` in `DependenciesConfig` must match between packages.

Update the template — replace the commented-out cli section with an active `cli_tools` section:

```yaml
# CLI tool dependencies
cli_tools:
  required: []
  #  - name: "docker"                           # Required: tool name
  #    install: "brew install docker"            # Required: install instructions

  optional: []
  #  - name: "terraform"
  #    install: "brew install terraform"
```

Keep the MCP section commented out (Phase 3).

**packages/cli/src/lib/config-loader.ts — Add cli_tools entry validation:**

The CLI has its own config-loader.ts (duplicated from hook). Update it the same way Plan 01 updates the hook's config.ts:

Add a `validateCliToolEntry(entry, path)` function:

- Entry must be an object
- `name` field required, must be non-empty string
- `install` field required, must be non-empty string

Update the `validateEcosystemSection` function to call `validateCliToolEntry` when `name === "cli_tools"` (or whatever the section name is passed as).

Also update the field references from `cli` to `cli_tools` in `validateConfig` (the part that checks `"cli" in obj`).

Similarly update `mcp` references to `mcp_servers` if the CONTEXT.md shows that — but checking CONTEXT.md, it only specifies `cli_tools` for this phase. Leave `mcp` as-is for Phase 3.

Actually, re-reading CONTEXT.md more carefully: the schema example shows `cli_tools:` as a YAML key. But the existing DependenciesConfig type in both packages uses `cli`. This is a Phase 2 implementation detail. The LOCKED decision says the schema uses `cli_tools` with required/optional arrays. So:

1. In `DependenciesConfig`, rename `cli?: EcosystemSection` to `cli_tools?: EcosystemSection`
2. In `validateConfig`, change `"cli" in obj` references to `"cli_tools" in obj`
3. In the "at least one section" check, update `hasCli` to check for `"cli_tools"`
4. Update all references accordingly
   </action>
   <verify>
   Run `pnpm typecheck` from repo root — should pass (CLI package is independent compilation). Check that the template output includes `cli_tools:` section.
   </verify>
   <done>
   CLI types include CliToolDependency and --yes in InitOptions/UpdateOptions. Template scaffolds cli_tools section with commented examples. Config loader validates cli_tools entries requiring name and install fields. DependenciesConfig uses `cli_tools` field name.
   </done>
   </task>

<task type="auto">
  <name>Task 2: --yes flag in init and update commands</name>
  <files>
    packages/cli/src/commands/init.ts
    packages/cli/src/commands/update.ts
    packages/cli/src/cli.ts
  </files>
  <action>
**packages/cli/src/commands/init.ts — Add --yes flag support:**

In the `builder`, add a `yes` option:

```typescript
.option("yes", {
  alias: "y",
  describe: "Skip prompts and use defaults (non-interactive mode)",
  type: "boolean",
  default: false,
})
```

In the `handler`, thread `argv.yes` through the entire flow. When `argv.yes` is true:

1. **Skip mode confirmation prompt** — use detected mode directly, log it with `p.log.info` (no `p.confirm`)
2. **Skip proceed confirmation** — proceed directly, log file actions with `p.log.info` (no `p.confirm`)
3. **Use defaults for all decisions** — detected mode, no force override
4. **Quieter output** — use `p.log.info` instead of `p.intro`/`p.outro` for cleaner log output. Skip the intro/outro banners. Just log what's happening.

Implementation pattern — wrap each prompt point in a match:

```typescript
const proceed = match(argv.yes)
  .with(true, () => true)
  .with(false, async () => {
    const result = await p.confirm({ message: "Proceed?", initialValue: false });
    if (p.isCancel(result)) {
      p.cancel("Operation cancelled");
      process.exit(0);
    }
    return result;
  })
  .exhaustive();
```

For the mode confirmation, when `--yes`:

- Skip the "Use detected mode?" prompt
- Use detected mode directly
- Log: `p.log.info(\`Mode: ${detectedMode} (auto)\`)`

For the proceed confirmation, when `--yes`:

- Still show the file action list (informational)
- Skip the "Proceed?" prompt
- Proceed directly

For intro/outro, when `--yes`:

- Skip `p.intro()` — just log `p.log.info("anthropak init")`
- Skip `p.outro()` — just log `p.log.info("Edit dependencies.yaml to declare your dependencies.")`

The key principle: `--yes` means NO stdin reads at all. Every @clack/prompts call that reads stdin must be guarded.

**packages/cli/src/commands/update.ts — Add --yes flag support:**

Same pattern as init.ts. Add `yes` option to builder. In handler:

1. Skip proceed confirmation when `--yes`
2. Quieter output when `--yes`
3. Still show file action list (informational)

Update has fewer prompts than init (no mode detection), so it's simpler:

- Guard the `p.confirm` call for proceed
- Guard `p.intro`/`p.outro`

**packages/cli/src/cli.ts — No changes needed** (yargs picks up options from command builders automatically). But verify the `--yes` flag doesn't conflict with the `--version` alias. The version alias is `-v`, and yes alias is `-y`, so no conflict.

No changes to cli.ts are expected, but verify it still works correctly with `pnpm build`.
</action>
<verify>
Run `pnpm build` from repo root — both packages should build. Run `pnpm typecheck` — zero errors. Run `pnpm lint` — no new errors.

Verify non-interactive mode:

- Build the CLI: `pnpm build`
- Run in a temp directory: `node packages/cli/dist/cli.mjs init --yes /tmp/test-anthropak-yes`
- Confirm it completes without hanging for input
- Verify files were created in /tmp/test-anthropak-yes/
  </verify>
  <done>
  `anthropak init --yes` runs fully non-interactively — no prompts, auto-detects mode, writes files with defaults. `anthropak update --yes` runs fully non-interactively. Both commands produce quieter output in --yes mode. No stdin reads occur when --yes is passed.
  </done>
  </task>

</tasks>

<verification>
1. `pnpm build` succeeds with no errors (hook → CLI pipeline)
2. `pnpm typecheck` passes with zero type errors
3. `pnpm lint` passes (pre-existing warnings acceptable)
4. `packages/cli/src/types.ts` contains `CliToolDependency` interface and `yes` in InitOptions/UpdateOptions
5. `packages/cli/src/templates/dependencies-yaml.ts` includes active `cli_tools:` section with commented examples
6. Running `node packages/cli/dist/cli.mjs init --yes /tmp/test-dir` completes without stdin reads
7. Running `node packages/cli/dist/cli.mjs update --yes /tmp/test-dir` completes without stdin reads
8. Config loader validates cli_tools entries (rejects missing name or install)
9. No ternary operators in new/modified code — all control flow via ts-pattern match()
10. No try-catch blocks — all error handling via attemptAsync
</verification>

<success_criteria>

- `anthropak init --yes` scaffolds all files without prompts, using detected mode defaults
- `anthropak update --yes` updates hook without prompts
- Scaffolded dependencies.yaml includes cli_tools section with commented-out examples showing name + install format
- --yes mode produces cleaner output (no banners, info-level messages only)
- Config validation rejects cli_tools entries missing name or install
- DependenciesConfig type uses `cli_tools` field name (matching CONTEXT.md schema decision)
- Zero ternaries, zero try-catch in all new/modified code
  </success_criteria>

<output>
After completion, create `.planning/phases/02-cli-tool-dependencies/02-02-SUMMARY.md`
</output>
