---
phase: 02-cli-tool-dependencies
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/hook/src/types.ts
  - packages/hook/src/lib/cli-detector.ts
  - packages/hook/src/checkers/cli-tools.ts
  - packages/hook/src/lib/config.ts
  - packages/hook/src/lib/output.ts
  - packages/hook/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Hook detects missing CLI tools from dependencies.yaml and reports them in systemMessage"
    - "CLI tool detection works cross-platform (which on Unix, where on Windows)"
    - "Missing required tools appear before optional tools in output, clearly tagged"
    - "When all CLI tools are found, a summary line is shown (CLI Tools: N/N found)"
    - "Hook never crashes when cli_tools section is present — malformed entries produce validation errors"
  artifacts:
    - path: "packages/hook/src/lib/cli-detector.ts"
      provides: "Cross-platform tool detection using child_process.execFile"
    - path: "packages/hook/src/checkers/cli-tools.ts"
      provides: "CLI tool dependency checker with parallel execution"
    - path: "packages/hook/src/types.ts"
      provides: "CliToolDependency type and updated CheckResult"
    - path: "packages/hook/src/lib/output.ts"
      provides: "CLI tool missing message formatting"
    - path: "packages/hook/src/lib/config.ts"
      provides: "cli_tools entry validation (name + install fields)"
  key_links:
    - from: "packages/hook/src/index.ts"
      to: "packages/hook/src/checkers/cli-tools.ts"
      via: "checkCliTools import and call"
      pattern: "checkCliTools"
    - from: "packages/hook/src/checkers/cli-tools.ts"
      to: "packages/hook/src/lib/cli-detector.ts"
      via: "checkToolExists import"
      pattern: "checkToolExists"
    - from: "packages/hook/src/lib/output.ts"
      to: "packages/hook/src/types.ts"
      via: "CliToolDependency type import"
      pattern: "CliToolDependency"
---

<objective>
Add CLI tool dependency detection to the hook package — cross-platform detection utility, CLI tool checker, config validation for cli_tools entries, and output formatting for missing tool messages.

Purpose: Extends hook from single-ecosystem (plugins) to two-ecosystem (plugins + CLI tools) dependency checking. Users declaring CLI tool dependencies in dependencies.yaml will see clear guidance when tools are missing.

Output: Hook package that detects CLI tools via which/where, validates cli_tools config entries, and produces grouped systemMessage output for missing tools.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/02-cli-tool-dependencies/02-CONTEXT.md
@.planning/phases/02-cli-tool-dependencies/02-RESEARCH.md
@.planning/phases/01-core-rebuild/01-01-SUMMARY.md

@packages/hook/src/types.ts
@packages/hook/src/index.ts
@packages/hook/src/lib/config.ts
@packages/hook/src/lib/output.ts
@packages/hook/src/lib/constants.ts
@packages/hook/src/checkers/plugins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, CLI detector utility, and config validation</name>
  <files>
    packages/hook/src/types.ts
    packages/hook/src/lib/cli-detector.ts
    packages/hook/src/lib/config.ts
  </files>
  <action>
**packages/hook/src/types.ts — Add CLI tool types, rename cli field, and update CheckResult:**

IMPORTANT RENAME: The CONTEXT.md locks `cli_tools` as the YAML key (not `cli`). In `DependenciesConfig`, rename `cli?: EcosystemSection` to `cli_tools?: EcosystemSection`. This is a user-locked decision — the YAML key is `cli_tools` and the TypeScript field must match. Leave `mcp` as-is (Phase 3 will handle its rename if needed).

Add a `CliToolDependency` interface with two required fields:

- `name: string` — tool name (e.g. "docker")
- `install: string` — user-provided install instructions (e.g. "brew install docker")

Add a `CliToolCheckResult` interface with:

- `missingRequired: CliToolDependency[]`
- `missingOptional: CliToolDependency[]`
- `totalRequired: number`
- `totalOptional: number`

Keep `DependencyEntry = PluginDependency` as-is for the plugins section. The `cli_tools` section's entries will be validated as `CliToolDependency` shapes (not `PluginDependency` shapes) by config.ts. Keep the `EcosystemSection` generic but add a comment noting that cli_tools entries are `CliToolDependency` shape while plugins entries are `PluginDependency` shape.

**packages/hook/src/lib/cli-detector.ts — Cross-platform tool detection utility:**

Create a new file implementing two exported functions:

1. `getDetectionCommand(toolName: string): { command: string; args: string[] }` — Uses `match(process.platform)` with `.with("win32", ...)` returning `{ command: "where", args: [toolName] }` and `.otherwise(...)` returning `{ command: "which", args: [toolName] }`. Do NOT use `.exhaustive()` here — `.otherwise()` is correct since platform has many possible string values beyond win32.

2. `checkToolExists(toolName: string): Promise<boolean>` — Wraps `child_process.execFile` in `attemptAsync`. Creates a `Promise<boolean>` that:
   - Sets a `setTimeout` of 3000ms (3 seconds) that rejects with `new Error("timeout")`
   - Calls `execFile(command, args, (err) => ...)` — resolves `true` if no error, `false` if error
   - Clears the timeout on callback
   - The outer attemptAsync treats any error (including timeout) as `false`

Import `execFile` from `"node:child_process"`, `attemptAsync` from `"es-toolkit"`, and `match` from `"ts-pattern"`.

**packages/hook/src/lib/config.ts — Rename cli to cli_tools and add entry validation:**

First, update `validateConfig` to use the new field name: rename all references from `"cli"` to `"cli_tools"`. Specifically:

- Change `const hasCli = "cli" in obj` to `const hasCli = "cli_tools" in obj`
- Change `obj.cli` to `obj.cli_tools`
- Change `validateEcosystemSection(obj.cli, "cli")` to `validateEcosystemSection(obj.cli_tools, "cli_tools")`
- Change `config.cli = ...` to `config.cli_tools = ...`

Then, the current `validateEcosystemSection` validates plugin entries deeply when `name === "plugins"` and does basic array-only validation for cli/mcp. Update this:

When `name === "cli_tools"`, validate each entry as a CLI tool entry using a new `validateCliToolEntry(entry, path)` function (similar structure to existing `validatePluginEntry`):

- Entry must be an object
- `name` field required, must be a non-empty string
- `install` field required, must be a non-empty string
- No optional fields (unlike plugins which have github/install/description)

Keep `name === "mcp"` as basic array validation (Phase 3).

Follow the existing pattern: iterate over required and optional arrays, call `validateCliToolEntry` for each, collect errors. Return validated section or errors.
</action>
<verify>
Run `pnpm build` from the repo root. Hook package should compile without errors. Run `pnpm typecheck` to confirm type safety.
</verify>
<done>
CliToolDependency type exists with name and install fields. cli-detector.ts exports checkToolExists using execFile with 3s timeout. config.ts validates cli_tools entries requiring name and install fields. All compile without errors.
</done>
</task>

<task type="auto">
  <name>Task 2: CLI tools checker, output formatting, and entry point integration</name>
  <files>
    packages/hook/src/checkers/cli-tools.ts
    packages/hook/src/lib/output.ts
    packages/hook/src/index.ts
  </files>
  <action>
**packages/hook/src/checkers/cli-tools.ts — CLI tool checker:**

Create a new file following the pattern of `checkers/plugins.ts`. Export a single async function:

```
async function checkCliTools(config: DependenciesConfig): Promise<CliToolCheckResult>
```

Implementation:

- If `!config.cli_tools`, return empty result (all zero counts)
- Extract `required` and `optional` arrays from `config.cli_tools`
- Cast entries to `CliToolDependency[]` (they've been validated by config.ts)
- Run all tool checks in parallel using `Promise.all`:
  - Map over `[...required, ...optional]`, calling `checkToolExists(tool.name)` for each
  - Collect results as `{ name: string, exists: boolean }[]`
- Build a `Map<string, boolean>` from results
- Filter `required` and `optional` arrays for tools where `exists === false`
- Return `CliToolCheckResult` with missingRequired, missingOptional, totalRequired: required.length, totalOptional: optional.length

Import `checkToolExists` from `"../lib/cli-detector.js"`.

**packages/hook/src/lib/output.ts — CLI tool message formatting:**

Add a new function `formatMissingCliTools(missing: CliToolDependency[], required: boolean): string` following the existing `formatMissingDependencies` pattern:

- Header: use `match(required)` with `.with(true, () => "**Missing Required CLI Tools**")` and `.with(false, () => "**Missing Optional CLI Tools**")` `.exhaustive()`
- For each tool: `- **${tool.name}** (${required ? "required" : "optional"})` — BUT use match() not ternary: `match(required).with(true, () => "required").with(false, () => "optional").exhaustive()`
- Next line: `` `  \`${tool.install}\` ``

Add a new function `formatCliToolsSummary(checkResult: CliToolCheckResult): string`:

- Calculate total = totalRequired + totalOptional
- Calculate found = total - missingRequired.length - missingOptional.length
- Return `"CLI Tools: ${found}/${total} found"`

Update `buildHookResponse` to accept an optional `cliToolResult?: CliToolCheckResult` parameter:

- After plugin sections, if cliToolResult is provided:
  - If there are missing required CLI tools, add `formatMissingCliTools(cliToolResult.missingRequired, true)` to parts
  - If there are missing optional CLI tools, add `formatMissingCliTools(cliToolResult.missingOptional, false)` to parts
  - If NO CLI tools are missing (both arrays empty) AND total > 0, add the summary line `formatCliToolsSummary(cliToolResult)` to parts
- Update the "all good" check: empty response only when BOTH plugins and cli tools have nothing missing, and cli tools total is 0 (or no cli section)

Import `CliToolDependency` and `CliToolCheckResult` from types.

**packages/hook/src/index.ts — Integrate CLI tool checking:**

After the plugin check (`checkPlugins`), add the CLI tool check:

- Import `checkCliTools` from `"./checkers/cli-tools.js"`
- In the success branch of the match on loadResult, after `checkPlugins`, call `const cliToolResult = await checkCliTools(config)`
- Pass `cliToolResult` to `buildHookResponse(checkResult, cliToolResult)`

The crash-proof wrapper already protects against unexpected errors, so the cli-tools checker is safe to call within it.
</action>
<verify>
Run `pnpm build` from the repo root — both packages should build successfully. Run `pnpm typecheck` — zero type errors. Run `pnpm lint` — no new errors (warnings for no-await-in-loop are acceptable).
</verify>
<done>
checkers/cli-tools.ts runs all tool checks in parallel via Promise.all. output.ts formats missing CLI tools grouped by required/optional with install instructions. index.ts calls checkCliTools and passes result to buildHookResponse. Hook builds and typechecks cleanly.
</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with no errors (hook → CLI pipeline)
2. `pnpm typecheck` passes with zero type errors
3. `pnpm lint` passes (pre-existing warnings acceptable)
4. New file `packages/hook/src/lib/cli-detector.ts` exists and exports `checkToolExists`
5. New file `packages/hook/src/checkers/cli-tools.ts` exists and exports `checkCliTools`
6. `packages/hook/src/types.ts` contains `CliToolDependency` interface
7. `packages/hook/src/lib/config.ts` validates cli_tools entries (name + install required)
8. `packages/hook/src/lib/output.ts` contains `formatMissingCliTools` function
9. `packages/hook/src/index.ts` calls `checkCliTools` in the success path
10. No `child_process.exec` usage — only `execFile` (security)
11. No ternary operators in new code — all control flow via ts-pattern match()
12. No try-catch blocks — all error handling via attemptAsync
</verification>

<success_criteria>

- Hook detects missing CLI tools and includes them in systemMessage output
- CLI tool detection uses cross-platform commands (which/where) via execFile
- Each tool check has a 3-second timeout, all checks run in parallel
- Missing tools grouped by priority (required first, optional second) with install instructions
- "All found" summary line shown when all CLI tools are present
- Config validation rejects cli_tools entries missing name or install fields
- Zero ternaries, zero try-catch in all new code
  </success_criteria>

<output>
After completion, create `.planning/phases/02-cli-tool-dependencies/02-01-SUMMARY.md`
</output>
